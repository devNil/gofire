<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="Content-type" content="text/html; charset=utf-8">
	<title>gochat-Test</title>
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.0/jquery.min.js"></script>
	<script src="js/core.js" type="text/javascript" charset="utf-8"></script>
	<script type="text/javascript" charset="utf-8">

	var conn = "ws://{{$}}/ws"
	
	var websocket;
	
	const command = {"Type":0,"Value":window.btoa("")}
	
	const REGISTER = 0
	const MESSAGE = 1
	const BLOGIN = 2
	const BLOGOUT = 3
	const BMESSAGE = 4
	
	function appendNormalMessage(user, message){
		$("#messages").append($("<div/>").text(user+" | "+message));
		$("#messages").scrollTop($("#messages").prop("scrollHeight"));
	}
	
	function submitMessage(){
		var msg = $("#msg").val();
		if(msg != ""){
			command.Type = BMESSAGE
			command.Value = window.btoa(msg)
			websocket.send(JSON.stringify(command))
			event.preventDefault()
			//reset the input box and reset the focus.
			$("#msg").val("")
			$("#messages").scrollTop($("#messages").prop("scrollHeight"));
		}
		$("#msg").focus();
	}
	
	
	function connect(){
		websocket = new WebSocket(conn)
		
		websocket.onclose = function(evt){
			$("#messages").append($("<div>").text("Closed"))
			$("#messages").scrollTop($("#messages").prop("scrollHeight"));
		}
		
		websocket.onopen = function(evt){
			command.Type = REGISTER
			command.Value = window.btoa(username)
			this.send(JSON.stringify(command))
			
			
			command.Type = BLOGIN
			command.Value = window.btoa("")
			this.send(JSON.stringify(command))
		}
			
		websocket.onmessage = function(evt){
			var command = JSON.parse(evt.data);
			
			switch(command.Type){
				case BMESSAGE:
					message = JSON.parse(window.atob(command.Value))
					appendNormalMessage(message.Usr.Name, window.atob(message.Msg))
				default:
			}
		}
		
	}
	
	
	var username;
	
	$(function(){
		
		username = sessionStorage["usr"];
		
		$($("h1")[0]).text(conn);
		
		connect();
		
		$("#msg").keyup(function(event){
			if(event.which === 13){
				submitMessage();
			}
		})
		
		$("#send").click(function(){
			submitMessage();
		})

		$("#logout").click(function(){
			command.Type = BLOGOUT			
			command.Value = window.btoa("")
			websocket.send(JSON.stringify(command))

		})
	});
	</script>
	<style type="text/css" media="screen">
		h1{
			font-size:18px;
		}
		#messages{
			overflow: auto;
			height:300px;
			max-height: 300px;
			width:640px;
			background-color:#EEEEEE;
		}
	</style>
</head>
<body>
	<h1></h1>
	<div id="messages">
	</div>
	<input type="text" id="msg"><button id="send">Send</button>
	<button id="logout">Logout</button>
</body>
</html>
